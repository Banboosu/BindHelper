<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视障人士外出安全辅助</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      color: #2c3e50;
    }
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      flex: 1;
    }
    .video-container {
      flex: 1;
      min-width: 300px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .video-wrapper {
      position: relative;
      width: 100%;
      background-color: #000;
      border-radius: 4px;
      overflow: hidden;
    }
    #videoElement {
      width: 100%;
      height: auto;
      display: block;
    }
    #canvas {
      display: none;
    }
    .chat-container {
      flex: 1;
      min-width: 300px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 4px;
      margin-bottom: 15px;
      min-height: 300px;
      max-height: 500px;
      font-size: 16px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .input-area {
      display: flex;
      gap: 10px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    /* Style for the active button */
    #controlButton.active {
      background-color: #e74c3c; /* Red color */
    }
    #controlButton.active:hover {
      background-color: #c0392b; /* Darker red on hover */
    }
    .controls {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    .status {
      text-align: center;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-style: italic;
      color: #666;
    }
    .error {
      color: #e74c3c;
      text-align: center;
      margin: 10px 0;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    .focus-outline:focus {
      outline: 3px solid #4CAF50;
      outline-offset: 2px;
    }
    .accessibility-controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4CAF50;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #4CAF50;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .voice-controls select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      .accessibility-controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    /* 加载状态样式 */
    .loading-indicator {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(76, 175, 80, 0.3);
      border-radius: 50%;
      border-top-color: #4CAF50;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 拖放区域样式 */
    #dropZone {
      transition: all 0.3s ease;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #dropZone:hover {
      background-color: #e8f4e9 !important;
      border-color: #45a049 !important;
    }
    
    #dropZone p {
      margin: 5px 0;
      color: #666;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
      #dropZone {
        padding: 15px 10px !important;
        min-height: 80px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>视障人士外出安全辅助</h1>
      <p>使用摄像头实时获取画面并提示周边环境安全信息</p>
    </header>
    
    <div class="main-content">
      <div class="video-container" role="region" aria-label="摄像头控制区域">
        <h2 id="videoHeading">摄像头画面</h2>
        <div class="video-wrapper" aria-describedby="videoHeading">
          <video id="videoElement" autoplay playsinline aria-label="实时摄像头画面"></video>
          <canvas id="canvas"></canvas>
          <img id="previewImage" style="display: none; width: 100%; height: auto; position: absolute; top: 0; left: 0;" aria-label="上传图片预览"/>
        </div>
        <div class="controls" role="toolbar" aria-label="摄像头控制">
          <button id="controlButton" class="focus-outline" aria-label="开启摄像头与安全辅助">开启摄像头与辅助</button>
        </div>
        <p id="videoStatus" class="status" role="status" aria-live="polite">摄像头与辅助已关闭</p>
        <div id="browserWarning" class="error" style="display:none;" role="alert"></div>
        
        <!-- 增强图片上传区域的UI -->
        <div id="imageUploadContainer" style="margin-top: 15px;">
          <hr>
          <h3>图片上传功能</h3>
          <p>您可以上传图片进行分析，或用于调试和演示</p>
          
          <!-- 拖放区域 -->
          <div id="dropZone" class="focus-outline" style="border: 2px dashed #3498db; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 10px; background-color: #f8f9fa; cursor: pointer;">
            <p><i>拖放图片到此处，或点击选择文件</i></p>
            <p><i>也可以直接粘贴剪贴板中的图片 (Ctrl+V)</i></p>
            <input type="file" id="imageFileInput" class="focus-outline" accept="image/*" aria-label="选择图片文件" style="display: none;" />
          </div>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="uploadImageButton" class="focus-outline" aria-label="上传并分析图片">上传并分析</button>
            <button id="showInVideoButton" class="focus-outline" aria-label="在视频区域显示图片">在视频区域显示</button>
            <button id="clearImageButton" class="focus-outline" aria-label="清除图片" style="background-color: #e74c3c;">清除图片</button>
          </div>
          <div style="margin-top: 10px;">
            <button id="analyzeCurrentImageButton" class="focus-outline" style="background-color: #3498db; width: 100%;" aria-label="分析当前显示的图片">分析当前显示的图片</button>
            <button id="captureScreenshotButton" class="focus-outline" style="background-color: #9b59b6; width: 100%; margin-top: 5px;" aria-label="截取当前画面">截取当前画面</button>
          </div>
        </div>
      </div>
      
      <div class="chat-container" role="region" aria-label="AI描述区域">
        <h2 id="chatHeading">安全提示</h2>
        <div id="chatMessages" class="chat-messages" role="log" aria-live="polite" aria-labelledby="chatHeading" tabindex="0"></div>
        <div class="input-area" role="form">
          <label for="messageInput" class="sr-only">输入提示词</label>
          <input type="text" id="messageInput" class="focus-outline" placeholder="输入特定需求，如'注意红绿灯'或'寻找座位'..." aria-label="输入特定需求，引导系统关注特定信息" />
          <button id="sendButton" class="focus-outline" aria-label="发送提示词">发送</button>
        </div>
        <p id="chatStatus" class="status" role="status" aria-live="polite">等待连接...</p>
        
        <div class="accessibility-controls" role="region" aria-labelledby="accessibilityHeading">
          <h3 id="accessibilityHeading">无障碍功能</h3>
          <div>
            <label for="ttsToggle" class="toggle-switch">
              <input type="checkbox" id="ttsToggle" checked aria-label="开启或关闭语音播报">
              <span class="slider"></span>
            </label>
            <span id="ttsLabel">语音播报已开启</span>
          </div>
          
          <div class="voice-controls">
            <label for="voiceSelect">选择语音：</label>
            <select id="voiceSelect" class="focus-outline" aria-label="选择语音类型"></select>
          </div>
          
          <div>
            <label for="rateRange">语速：</label>
            <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1.5" class="focus-outline" aria-label="调整语音速度">
            <span id="rateValue">1.5</span>
          </div>
          
          <button id="speakNowButton" class="focus-outline" aria-label="立即朗读当前描述">立即朗读当前描述</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM元素
      const videoElement = document.getElementById('videoElement');
      const canvas = document.getElementById('canvas');
      const controlButton = document.getElementById('controlButton');
      const videoStatus = document.getElementById('videoStatus');
      const chatMessages = document.getElementById('chatMessages');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const chatStatus = document.getElementById('chatStatus');
      
      // 无障碍控制元素
      const ttsToggle = document.getElementById('ttsToggle');
      const ttsLabel = document.getElementById('ttsLabel');
      const voiceSelect = document.getElementById('voiceSelect');
      const rateRange = document.getElementById('rateRange');
      const rateValue = document.getElementById('rateValue');
      const speakNowButton = document.getElementById('speakNowButton');

      // 备用图片上传功能
      const imageUploadContainer = document.getElementById('imageUploadContainer');
      const imageFileInput = document.getElementById('imageFileInput');
      const uploadImageButton = document.getElementById('uploadImageButton');
      const showInVideoButton = document.getElementById('showInVideoButton');
      const clearImageButton = document.getElementById('clearImageButton');

      // 添加变量引用
      const analyzeCurrentImageButton = document.getElementById('analyzeCurrentImageButton');
      const captureScreenshotButton = document.getElementById('captureScreenshotButton');

      // Socket.io连接
      const socket = io();
      let isCapturing = false;
      let captureInterval;
      let stream = null;

      // 视频流配置 - 降低分辨率以减少网络带宽和处理负担
      const constraints = {
        video: {
          width: { ideal: 640 },    // 从1280降低到640
          height: { ideal: 480 },   // 从720降低到480
          frameRate: { ideal: 10 }  // 从15降低到10
        }
      };
      
      // TTS功能初始化
      let speechSynthesisInstance = null;
      let speechUtterance = null;
      let voices = [];
      let selectedVoice = null;
      let isSpeaking = false;
      let currentText = "";
      let ttsEnabled = true;
      
      // 安全获取语音合成API
      function getSpeechSynthesis() {
        if (speechSynthesisInstance === null) {
          try {
            speechSynthesisInstance = window.speechSynthesis || null;
          } catch (e) {
            console.error('获取语音合成API失败:', e);
            speechSynthesisInstance = null;
          }
        }
        return speechSynthesisInstance;
      }
      
      // 检查TTS支持
      function checkTTSSupport() {
        const synth = getSpeechSynthesis();
        const supportsTTS = synth !== null && typeof synth !== 'undefined';
        
        if (!supportsTTS) {
          console.error('浏览器不支持语音合成API');
          ttsToggle.disabled = true;
          ttsToggle.checked = false;
          ttsEnabled = false;
          ttsLabel.textContent = '当前浏览器不支持语音合成';
        }
        
        return supportsTTS;
      }
      
      // 修复语音合成函数，确保完整句子一次性朗读
      function speakText(text) {
        const synth = getSpeechSynthesis();
        if (!ttsEnabled || !synth || !text) return;
        
        // 如果正在朗读，先停止
        if (isSpeaking) {
          stopSpeaking();
        }
        
        try {
          // 解析文本，移除多余的句号和空格
          let cleanedText = text.trim();
          
          // 移除单独的标点符号行
          cleanedText = cleanedText.replace(/^\s*[.。，,;；!！?？]\s*$/gm, '');
          
          // 移除重复的标点符号
          cleanedText = cleanedText.replace(/([.。，,;；!！?？])\1+/g, '$1');
          
          // 移除不必要的空白行
          cleanedText = cleanedText.replace(/\n\s*\n/g, '\n');
          
          if (!cleanedText) return; // 如果清理后没有内容则不朗读
          
          console.log('准备朗读文本:', cleanedText);
          
          speechUtterance = new SpeechSynthesisUtterance(cleanedText);
          
          if (selectedVoice) {
            speechUtterance.voice = selectedVoice;
          }
          
          speechUtterance.rate = parseFloat(rateRange.value);
          speechUtterance.lang = selectedVoice ? selectedVoice.lang : 'zh-CN';
          
          speechUtterance.onstart = () => {
            isSpeaking = true;
            console.log('语音合成开始');
          };
          
          speechUtterance.onend = () => {
            isSpeaking = false;
            console.log('语音合成结束');
          };
          
          speechUtterance.onerror = (event) => {
            console.error('语音合成错误:', event);
            isSpeaking = false;
          };
          
          synth.speak(speechUtterance);
        } catch (e) {
          console.error('语音播报失败:', e);
          ttsEnabled = false;
          ttsToggle.checked = false;
          ttsLabel.textContent = '语音播报功能不可用';
        }
      }
      
      // 停止朗读
      function stopSpeaking() {
        const synth = getSpeechSynthesis();
        if (synth && isSpeaking) {
          try {
            synth.cancel();
            isSpeaking = false;
          } catch (e) {
            console.error('停止语音合成失败:', e);
          }
        }
      }
      
      // 公告消息（不使用TTS开关）
      function announceMessage(text) {
        const synth = getSpeechSynthesis();
        if (!synth || !text) return;
        
        try {
          const announcement = new SpeechSynthesisUtterance(text);
          if (selectedVoice) {
            announcement.voice = selectedVoice;
          }
          announcement.rate = parseFloat(rateRange.value);
          synth.speak(announcement);
        } catch (e) {
          console.error('公告播报失败:', e);
        }
      }
      
      // 初始化语音合成
      function initSpeechSynthesis() {
        const synth = getSpeechSynthesis();
        if (!synth) {
          ttsToggle.disabled = true;
          ttsLabel.textContent = '当前浏览器不支持语音合成';
          // 提供可见的错误消息
          document.getElementById('browserWarning').innerHTML = 
            '<p>您的浏览器不支持语音合成功能。请尝试使用Chrome或Safari的最新版本。</p>';
          document.getElementById('browserWarning').style.display = 'block';
          return false;
        }
        
        // 加载可用的语音
        function loadVoices() {
          try {
            voices = synth.getVoices();
            
            // 清空下拉列表
            voiceSelect.innerHTML = '';
            
            // 检查是否有可用语音
            if (!voices || voices.length === 0) {
              setTimeout(loadVoices, 1000); // 在某些移动设备上可能需要延迟加载
              return;
            }
            
            // 过滤中文语音
            const chineseVoices = voices.filter(voice => 
              voice.lang.includes('zh') || voice.lang.includes('cmn')
            );
            
            // 如果没有中文语音，就显示所有语音
            const voicesToShow = chineseVoices.length > 0 ? chineseVoices : voices;
            
            // 添加语音选项
            voicesToShow.forEach((voice, index) => {
              const option = document.createElement('option');
              option.textContent = `${voice.name} (${voice.lang})`;
              option.setAttribute('data-voice-uri', voice.voiceURI);
              option.value = index;
              voiceSelect.appendChild(option);
            });
            
            // 默认选择第一个中文语音
            if (voicesToShow.length > 0) {
              selectedVoice = voicesToShow[0];
              // 尝试找到更合适的语音
              for (let i = 0; i < voicesToShow.length; i++) {
                if (voicesToShow[i].name.includes('Xiaoyi') || 
                    voicesToShow[i].name.includes('Microsoft') ||
                    voicesToShow[i].name.includes('Chinese')) {
                  selectedVoice = voicesToShow[i];
                  voiceSelect.value = i;
                  break;
                }
              }
            }
          } catch (e) {
            console.error('加载语音失败:', e);
          }
        }
        
        // 处理语音选择更改
        voiceSelect.addEventListener('change', () => {
          try {
            const selectedIndex = parseInt(voiceSelect.value);
            if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < voices.length) {
              selectedVoice = voices[selectedIndex];
            }
          } catch (e) {
            console.error('语音选择变更失败:', e);
          }
        });
        
        // 延迟加载语音列表
        setTimeout(() => {
          try {
            loadVoices();
            
            // 在某些设备上需要监听语音变化事件
            if (synth.onvoiceschanged !== undefined) {
              synth.onvoiceschanged = loadVoices;
            }
          } catch (e) {
            console.error('语音初始化失败:', e);
          }
        }, 100);
        
        // 处理语速更改
        rateRange.addEventListener('input', () => {
          rateValue.textContent = rateRange.value;
        });
        
        // 处理TTS开关
        ttsToggle.addEventListener('change', () => {
          ttsEnabled = ttsToggle.checked;
          ttsLabel.textContent = ttsEnabled ? '语音播报已开启' : '语音播报已关闭';
          
          if (!ttsEnabled && isSpeaking) {
            stopSpeaking();
          }
        });
        
        // 立即朗读按钮
        speakNowButton.addEventListener('click', () => {
          if (currentText) {
            speakText(currentText);
          } else {
            announceMessage('没有可朗读的内容');
          }
        });
        
        return true;
      }
      
      // 初始化TTS并添加移动设备检测
      setTimeout(() => {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 在移动设备上等待更长时间以确保API可用
        if (isMobile) {
          document.getElementById('browserWarning').innerHTML += 
            '<p>移动设备提示：如果语音功能不工作，请尝试点击屏幕任意位置来激活语音功能。</p>';
          document.getElementById('browserWarning').style.display = 'block';
        }
        
        initSpeechSynthesis();
      }, 500);
      
      // 添加媒体设备API兼容性处理
      function checkMediaDevicesSupport() {
        // 检查浏览器是否支持mediaDevices
        if (!navigator.mediaDevices) {
          navigator.mediaDevices = {};
        }
        
        // 检查getUserMedia支持
        if (!navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia = function(constraints) {
            // 获取较老的浏览器版本中可能存在的getUserMedia实现
            const getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            
            if (!getUserMedia) {
              videoStatus.textContent = '您的浏览器不支持摄像头访问功能';
              announceMessage('您的浏览器不支持摄像头访问功能，请尝试使用Chrome或Safari最新版本');
              return Promise.reject(new Error('getUserMedia 不被支持'));
            }
            
            // 封装旧的getUserMedia接口为Promise
            return new Promise(function(resolve, reject) {
              getUserMedia.call(navigator, constraints, resolve, reject);
            });
          };
        }
      }
      
      // 检查是否为安全上下文(HTTPS)
      function checkSecureContext() {
        if (window.isSecureContext === false) {
          videoStatus.textContent = '需要在HTTPS安全环境下访问摄像头';
          announceMessage('安全限制：请使用HTTPS协议访问此页面以启用摄像头功能');
          controlButton.disabled = true;
          return false;
        }
        return true;
      }
      
      // 初始化摄像头环境
      function initCameraEnvironment() {
        try {
          checkMediaDevicesSupport();
          if (!checkSecureContext()) {
             controlButton.disabled = true;
             return false;
          }
          return true;
        } catch (error) {
          console.error('摄像头环境初始化失败:', error);
          videoStatus.textContent = '摄像头初始化失败: ' + error.message;
          announceMessage('摄像头功能初始化失败，请检查浏览器设置或尝试使用其他浏览器');
          controlButton.disabled = true;
          return false;
        }
      }
      
      // 启动摄像头并开始辅助的函数
      async function startCameraAndCapture() {
        if (stream && stream.active) {
            console.log("摄像头已在运行。");
            return;
        }

        try {
          announceMessage('正在启动摄像头');
          updateStatus(videoStatus, '正在启动摄像头...', true);
          controlButton.disabled = true;

          if (!checkBrowserCompatibility()) {
            updateStatus(videoStatus, '您的浏览器不支持摄像头API');
            announceMessage('您的浏览器不支持摄像头功能，请参考页面提示更换浏览器或设备');
            controlButton.disabled = false;
            return;
          }

          if (!initCameraEnvironment()) {
             controlButton.disabled = false;
            return;
          }

          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          if (isMobile) {
            constraints.video.facingMode = { ideal: 'environment' };
            constraints.video.width = { ideal: 720 };
            constraints.video.height = { ideal: 480 };
          }

          stream = await navigator.mediaDevices.getUserMedia(constraints);
          videoElement.srcObject = stream;
          await videoElement.play();

          updateStatus(videoStatus, '摄像头已开启，正在初始化分析...');
          
          // 初始化场景分析
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(videoElement, 0, 0);
          previousImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          isCapturing = true;
          // 捕获间隔从3000ms(3秒)增加到4000ms(4秒)以减轻服务器负担
          captureInterval = setInterval(captureAndSend, 4000);

          controlButton.textContent = '停止摄像头与辅助';
          controlButton.setAttribute('aria-label', '停止摄像头与安全辅助');
          controlButton.classList.add('active');
          controlButton.disabled = false;
          updateStatus(videoStatus, '摄像头与辅助已开启');
          announceMessage('摄像头与安全辅助已开启');

        } catch (error) {
          console.error('启动摄像头或辅助失败:', error);
          updateStatus(videoStatus, '启动失败: ' + error.message);
          controlButton.textContent = '开启摄像头与辅助';
          controlButton.setAttribute('aria-label', '开启摄像头与安全辅助');
          controlButton.classList.remove('active');
          controlButton.disabled = false;

          let errorMessage = '启动摄像头或辅助失败，';
          if (error.name === 'NotAllowedError') {
            errorMessage += '请检查摄像头权限设置';
          } else if (error.name === 'NotFoundError') {
            errorMessage += '未找到可用摄像头设备';
          } else if (error.name === 'NotReadableError') {
            errorMessage += '摄像头可能被其他应用占用';
          } else if (error.name === 'OverconstrainedError') {
            errorMessage += '摄像头不支持请求的分辨率';
            errorMessage += '. 请尝试刷新页面。';
          } else {
            errorMessage += error.message || '原因未知';
          }
          announceMessage(errorMessage);
          
          if (videoElement.srcObject) {
             videoElement.srcObject.getTracks().forEach(track => track.stop());
             videoElement.srcObject = null;
          }
          stream = null; 
          if (captureInterval) {
              clearInterval(captureInterval);
              captureInterval = null;
          }
          isCapturing = false;
        }
      }

      // 停止摄像头和辅助的函数
      function stopCameraAndCapture() {
         if (captureInterval) {
             clearInterval(captureInterval);
             captureInterval = null;
         }
         isCapturing = false;
         announceMessage('已停止安全辅助');

         if (stream) {
           updateStatus(videoStatus, '正在关闭摄像头...');
           stream.getTracks().forEach(track => track.stop());
           videoElement.srcObject = null;
           stream = null;
           announceMessage('摄像头已停止');
         }
         
         controlButton.textContent = '开启摄像头与辅助';
         controlButton.setAttribute('aria-label', '开启摄像头与安全辅助');
         controlButton.classList.remove('active');
         controlButton.disabled = false;
         updateStatus(videoStatus, '摄像头与辅助已关闭');
      }

      // 控制按钮的点击事件
      controlButton.addEventListener('click', () => {
        if (!isCapturing && !stream) {
          startCameraAndCapture();
        } else {
          stopCameraAndCapture();
        }
      });

      let previousImageData = null;
      const CHANGE_THRESHOLD = 40;
      
      function calculateFrameDifference(currentImageData, previousImageData) {
        const len = currentImageData.data.length;
        let diffCount = 0;
        
        for (let i = 0; i < len; i += 4) {
          const rDiff = Math.abs(currentImageData.data[i] - previousImageData.data[i]);
          const gDiff = Math.abs(currentImageData.data[i + 1] - previousImageData.data[i + 1]);
          const bDiff = Math.abs(currentImageData.data[i + 2] - previousImageData.data[i + 2]);
          
          if (rDiff > CHANGE_THRESHOLD || gDiff > CHANGE_THRESHOLD || bDiff > CHANGE_THRESHOLD) {
            diffCount++;
          }
        }
        
        return (diffCount / (len / 4)) * 100;
      }

      // 更新状态显示函数
      function updateStatus(element, message, isLoading = false) {
        if (!element) return;
        
        // 清除旧的加载指示器
        element.innerHTML = '';
        
        if (isLoading) {
          const loadingSpinner = document.createElement('span');
          loadingSpinner.className = 'loading-indicator';
          element.appendChild(loadingSpinner);
        }
        
        const statusText = document.createElement('span');
        statusText.textContent = ' ' + message;
        element.appendChild(statusText);
      }

      function captureAndSend() {
        // 如果用户显示上传的图片，跳过摄像头捕获
        if (isUsingUploadedImage) {
          // console.log("跳过帧捕获：正在显示上传的图片");
          return;
        }
        
        if (!isCapturing || !stream || !stream.active) {
          console.log("跳过帧捕获：摄像头未开启");
          return;
        }
        
        try {
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(videoElement, 0, 0);
          
          // 获取当前帧图像数据用于场景变化检测
          const currentImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          // 执行场景检测
          if (previousImageData) {
            const diffPercentage = calculateFrameDifference(currentImageData, previousImageData);
            
            // 将检测阈值调整为25%，减少连续相似画面的处理
            if (diffPercentage > 25) {
              updateStatus(chatStatus, "正在处理...", true);
              const frame = canvas.toDataURL('image/jpeg', 0.7); // 降低质量到0.7
              const message = messageInput.value.trim();
              
              // 发送到服务器前记录日志
              console.log(`发送视频帧: 场景变化率 ${diffPercentage.toFixed(1)}%, 帧大小约 ${Math.round(frame.length/1024)}KB`);
              
              socket.emit('videoFrame', { frame, message });
            }
          }
          
          // 保存当前帧为下一次比较的基准
          previousImageData = currentImageData;
        } catch (error) {
          console.error('捕获视频帧错误:', error);
          updateStatus(chatStatus, `捕获错误: ${error.message}`);
        }
      }

      sendButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
          addMessage('用户', message);
          messageInput.value = '';
          announceMessage(`已发送提示: ${message}`);
        }
      });

      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendButton.click();
        }
      });

      function addMessage(sender, text) {
        if (sender === 'AI') {
          // 清理显示文本，去除不必要的标点符号和空行
          let cleanedText = text.trim();
          
          // 移除只包含标点的行
          cleanedText = cleanedText.replace(/^\s*[.。，,;；!！?？]+\s*$/gm, '');
          
          // 移除多余的重复标点
          cleanedText = cleanedText.replace(/([.。，,;；!！?？])\1+/g, '$1');
          
          // 移除多余的空行
          cleanedText = cleanedText.replace(/\n\s*\n/g, '\n');
          
          if (!cleanedText.trim()) {
            console.warn('警告: AI响应清理后为空文本:', text);
            cleanedText = '(获取到空响应，请重试)';
          }
          
          // 更新当前文本和显示区域
          currentText = cleanedText;
          chatMessages.textContent = cleanedText + '\n\n';
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          // 文本已在speakText函数中清理，不需要重复清理
          if (ttsEnabled && checkTTSSupport()) {
            speakText(cleanedText);
          }
        } else if (sender === '用户') {
          // 如果需要显示用户消息，可以在这里添加逻辑
          // chatMessages.textContent += `你: ${text}\n\n`;
          // chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      socket.on('connect', () => {
        updateStatus(chatStatus, '服务已连接');
        announceMessage('服务器已连接');
      });

      socket.on('disconnect', () => {
        updateStatus(chatStatus, '连接断开');
        announceMessage('服务器连接已断开');
      });

      socket.on('error', (error) => {
        console.error('Socket错误:', error);
        const errorMessage = error && error.message ? error.message : '未知错误';
        updateStatus(chatStatus, '发生错误: ' + errorMessage);
        
        // 提供更详细的错误反馈
        if (errorMessage.includes('处理视频帧时出错')) {
          // 处理服务器端AI处理错误
          updateStatus(chatStatus, '视觉分析暂时不可用，请稍后重试');
          announceMessage('视觉分析服务暂时不可用，正在自动恢复中');
          
          // 不中断服务，等待下一次尝试
          console.log('AI处理错误，等待下一帧尝试');
        } else if (errorMessage.includes('请求过于频繁')) {
          // 速率限制错误，静默处理，不通知用户
          console.log('速率限制错误，降低请求频率');
          
          // 临时增加捕获间隔以应对速率限制
          if (captureInterval) {
            clearInterval(captureInterval);
            captureInterval = setInterval(captureAndSend, 5000); // 临时延长到5秒
          }
        } else {
          // 其他错误，停止捕获并重置按钮状态
          announceMessage(`发生错误: ${errorMessage}`);
          
          if (isCapturing) {
             if (captureInterval) {
                 clearInterval(captureInterval);
                 captureInterval = null;
             }
             isCapturing = false;
             controlButton.textContent = '开启摄像头与辅助';
             controlButton.setAttribute('aria-label', '开启摄像头与安全辅助');
             controlButton.classList.remove('active');
             announceMessage('由于错误，安全辅助已暂停，请重新启动');
          }
        }
      });

      socket.on('aiResponse', (response) => {
        updateStatus(chatStatus, "已收到分析结果");
        
        let textToDisplay = response.text;
        
        if (textToDisplay && typeof textToDisplay === 'string') {
          // 处理标记
          let shouldSpeak = true; // 默认播放语音
          if (textToDisplay.startsWith('[SPEAK]')) {
            textToDisplay = textToDisplay.substring(7).trim(); // 移除标记并去除空格
          } else if (textToDisplay.startsWith('[INFO]')) {
            textToDisplay = textToDisplay.substring(6).trim(); // 移除标记并去除空格
            shouldSpeak = false; // INFO标记不播放语音
          }
          
          // 清理显示文本，去除不必要的标点和空行
          let cleanedText = textToDisplay.trim();
          cleanedText = cleanedText.replace(/^\s*[.。，,;；!！?？]\s*$/gm, '');
          cleanedText = cleanedText.replace(/([.。，,;；!！?？])\1+/g, '$1');
          cleanedText = cleanedText.replace(/\n\s*\n/g, '\n');
          
          if (cleanedText.trim()) {
            console.log('显示和播报文本:', cleanedText);
            
            // 显示处理后的文本
            addMessage('AI', cleanedText);
            
            // 如果需要播报，则播报处理后的文本
            if (shouldSpeak && ttsEnabled && checkTTSSupport()) {
              speakText(cleanedText);
            }
          } else {
            console.warn("清理后文本为空:", textToDisplay);
          }
        } else {
          console.warn("Received empty or invalid aiResponse:", response);
        }
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.altKey && (e.key === 's' || e.key === 'c')) {
          e.preventDefault();
          controlButton.click();
        }
        else if (e.altKey && e.key === 'r') {
          e.preventDefault();
          speakNowButton.click();
        }
        else if (e.altKey && e.key === 't') {
          e.preventDefault();
          ttsToggle.checked = !ttsToggle.checked;
          const event = new Event('change');
          ttsToggle.dispatchEvent(event);
        }
      });
      
      setTimeout(() => {
        announceMessage('欢迎使用视障人士外出安全辅助系统。');
      }, 1000);

      function checkBrowserCompatibility() {
        const warningDiv = document.getElementById('browserWarning');
        let warningMessage = '';
        
        if (typeof navigator.mediaDevices === 'undefined') {
          warningMessage += '<p>您的浏览器不支持媒体设备API(MediaDevices)。';
          
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          if (isMobile) {
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
              warningMessage += '<p>iOS设备建议：<br>1. 请使用Safari浏览器<br>2. 确保iOS版本至少为11.0或更高<br>3. 确保未禁用摄像头权限</p>';
            } else if (/Android/i.test(navigator.userAgent)) {
              warningMessage += '<p>Android设备建议：<br>1. 请使用Chrome或Firefox最新版本<br>2. 确保已授予摄像头权限<br>3. 尝试清除浏览器缓存后重试</p>';
            }
          } else {
            warningMessage += '<p>桌面设备建议：<br>1. 请使用Chrome、Firefox或Edge最新版本<br>2. 确保网站使用HTTPS协议访问<br>3. 检查是否已授予摄像头权限</p>';
          }
          
          warningMessage += '<p>您可以使用下方的图片上传功能作为替代方案。</p>';
          
          warningDiv.innerHTML = warningMessage;
          warningDiv.style.display = 'block';
          
          imageUploadContainer.style.display = 'block';
          
          return false;
        }
        
        if (window.isSecureContext === false) {
          warningDiv.innerHTML = '<p>需要在HTTPS安全环境下访问摄像头。请使用HTTPS协议访问此页面。</p><p>您可以使用下方的图片上传功能作为替代方案。</p>';
          warningDiv.style.display = 'block';
          
          imageUploadContainer.style.display = 'block';
        }
        
        return true;
      }
      
      checkBrowserCompatibility();

      // 增加图片处理相关变量和函数
      let lastUploadedImage = null;
      let isUsingUploadedImage = false;

      // 显示上传的图片在预览区域
      function displayImageInVideoArea(imageDataUrl) {
        const previewImage = document.getElementById('previewImage');
        
        if (isCapturing && stream) {
          // 如果摄像头正在运行，暂停捕获
          updateStatus(videoStatus, '已暂停实时捕获，正在显示上传图片');
        }
        
        // 显示图片
        previewImage.src = imageDataUrl;
        previewImage.style.display = 'block';
        isUsingUploadedImage = true;
        
        // 更新状态
        updateStatus(videoStatus, '显示上传的图片（实时捕获已暂停）');
      }

      // 清除预览区域的图片
      function clearVideoAreaImage() {
        const previewImage = document.getElementById('previewImage');
        previewImage.style.display = 'none';
        isUsingUploadedImage = false;
        
        if (isCapturing && stream) {
          updateStatus(videoStatus, '已恢复实时捕获');
        } else {
          updateStatus(videoStatus, '摄像头未开启');
        }
      }

      // 处理图片文件的函数
      function processImageFile(file, forPreviewOnly = false) {
        if (!file) {
          announceMessage('请先选择图片文件');
          return;
        }
        
        if (!forPreviewOnly) {
          updateStatus(chatStatus, "正在处理图片...", true);
          announceMessage('正在分析上传的图片，请稍候');
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          // 创建图像对象以调整大小
          const img = new Image();
          img.onload = function() {
            // 创建canvas进行压缩
            const canvas = document.createElement('canvas');
            // 最大尺寸控制
            const MAX_WIDTH = 640;
            const MAX_HEIGHT = 480;
            
            let width = img.width;
            let height = img.height;
            
            // 按比例缩放
            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // 绘制调整后的图像
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // 转为base64，降低图片质量到70%
            const compressedImageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // 保存最后处理的图像
            lastUploadedImage = compressedImageData;
            
            if (forPreviewOnly) {
              // 只显示图片，不进行分析
              displayImageInVideoArea(compressedImageData);
              return;
            }
            
            const base64Data = compressedImageData.split(',')[1];
            console.log(`原始图像大小: ${Math.round(e.target.result.length/1024)}KB, 压缩后: ${Math.round(compressedImageData.length/1024)}KB`);
            
            const message = messageInput.value.trim();
            
            fetch('/api/chat', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                imageData: base64Data,
                message: message || '请描述画面中的重要信息'
              })
            })
            .then(response => {
              updateStatus(chatStatus, "AI正在分析...", true);
              
              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let buffer = '';
              let completeResponse = '';
              
              function readStream() {
                reader.read().then(({ done, value }) => {
                  if (done) {
                    updateStatus(chatStatus, "分析完成");
                    
                    // 在结束时显示和朗读完整的响应
                    if (completeResponse.trim()) {
                      addMessage('AI', completeResponse);
                    }
                    return;
                  }
                  
                  buffer += decoder.decode(value, { stream: true });
                  const lines = buffer.split('\n\n');
                  buffer = lines.pop() || '';
                  
                  lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                      const data = line.slice(6);
                      if (data === '[DONE]') {
                        updateStatus(chatStatus, "分析完成");
                        return;
                      }
                      
                      try {
                        const parsed = JSON.parse(data);
                        if (parsed.text) {
                          // 累积完整响应，但不立即显示
                          completeResponse += parsed.text;
                          // 更新状态以显示进度
                          const wordCount = completeResponse.length;
                          updateStatus(chatStatus, `AI正在分析...已收到${wordCount}个字符`, true);
                        } else if (parsed.error) {
                          updateStatus(chatStatus, `错误: ${parsed.error}`);
                          announceMessage(`处理图片时出错: ${parsed.error}`);
                        }
                      } catch (err) {
                        console.error('解析响应错误:', err);
                      }
                    }
                  });
                  
                  readStream();
                }).catch(err => {
                  console.error('读取流错误:', err);
                  updateStatus(chatStatus, '处理图片时出错');
                  announceMessage('处理图片时出错，请重试');
                  
                  // 尝试显示已收到的部分响应
                  if (completeResponse.trim()) {
                    addMessage('AI', completeResponse);
                  }
                });
              }
              
              readStream();
            })
            .catch(error => {
              console.error('上传图片错误:', error);
              updateStatus(chatStatus, '上传图片失败: ' + error.message);
              announceMessage('上传图片失败，请重试');
            });
          };
          
          img.src = e.target.result;
        };
        
        reader.readAsDataURL(file);
      }

      // 拖放区域事件处理
      const dropZone = document.getElementById('dropZone');
      
      // 点击拖放区域触发文件选择
      dropZone.addEventListener('click', () => {
        imageFileInput.click();
      });
      
      // 阻止默认拖放行为
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        }, false);
        document.body.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        }, false);
      });
      
      // 拖放区域视觉反馈
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = '#45a049';
          dropZone.style.backgroundColor = '#e8f4e9';
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = '#3498db';
          dropZone.style.backgroundColor = '#f8f9fa';
        }, false);
      });
      
      // 处理拖放的文件
      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          imageFileInput.files = files;
          announceMessage('已接收拖放的图片');
          processImageFile(files[0]);
        }
      }, false);
      
      // 剪贴板粘贴功能
      document.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        
        for (let i = 0; i < items.length; i++) {
          if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            
            reader.onload = (e) => {
              announceMessage('已从剪贴板获取图片');
              displayImageInVideoArea(e.target.result);
              // 创建一个新的文件对象并分析
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(blob);
              imageFileInput.files = dataTransfer.files;
              processImageFile(blob);
            };
            
            reader.readAsDataURL(blob);
            break;
          }
        }
      });
      
      // 更新事件监听器
      uploadImageButton.addEventListener('click', () => {
        const file = imageFileInput.files[0];
        processImageFile(file);
      });

      showInVideoButton.addEventListener('click', () => {
        const file = imageFileInput.files[0];
        if (!file) {
          announceMessage('请先选择图片文件');
          return;
        }
        
        processImageFile(file, true);
      });

      clearImageButton.addEventListener('click', () => {
        clearVideoAreaImage();
      });
      
      // 文件输入变化事件
      imageFileInput.addEventListener('change', () => {
        if (imageFileInput.files.length > 0) {
          announceMessage('已选择图片: ' + imageFileInput.files[0].name);
        }
      });

      // 截取当前摄像头画面
      function captureCurrentFrame() {
        // 确保摄像头已打开
        if (!isCapturing || !stream || !stream.active) {
          announceMessage('摄像头未开启，无法截图');
          return null;
        }
        
        try {
          // 确保canvas尺寸与视频一致
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          const ctx = canvas.getContext('2d');
          
          // 清除之前的内容
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          // 绘制当前视频帧
          ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
          
          // 获取图像
          const imageData = canvas.toDataURL('image/jpeg', 0.7);
          return imageData;
        } catch (error) {
          console.error('截图失败:', error);
          announceMessage('截图失败: ' + error.message);
          return null;
        }
      }

      // 更新分析当前图片的完整响应处理
      analyzeCurrentImageButton.addEventListener('click', () => {
        // 判断是使用上传图片还是当前摄像头画面
        let imageToAnalyze = null;
        
        if (isUsingUploadedImage && lastUploadedImage) {
          // 使用上传显示的图片
          imageToAnalyze = lastUploadedImage;
        } else if (document.getElementById('previewImage').style.display === 'block') {
          // 使用预览图
          imageToAnalyze = document.getElementById('previewImage').src;
        } else {
          // 尝试捕获当前摄像头画面
          imageToAnalyze = captureCurrentFrame();
        }
        
        if (!imageToAnalyze) {
          announceMessage('没有可分析的图片，请先上传图片或开启摄像头');
          return;
        }
        
        updateStatus(chatStatus, "正在分析当前图片...", true);
        announceMessage('正在分析图片，请稍候');
        
        // 确保imageToAnalyze是base64格式
        let base64Data = imageToAnalyze;
        if (base64Data.startsWith('data:image')) {
          base64Data = base64Data.split(',')[1];
        }
        
        const message = messageInput.value.trim();
        
        fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            imageData: base64Data,
            message: message || '请描述画面中的重要信息'
          })
        })
        .then(response => {
          updateStatus(chatStatus, "AI正在分析...", true);
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let completeResponse = '';
          
          function readStream() {
            reader.read().then(({ done, value }) => {
              if (done) {
                updateStatus(chatStatus, "分析完成");
                
                // 在结束时显示和朗读完整的响应
                if (completeResponse.trim()) {
                  addMessage('AI', completeResponse);
                }
                return;
              }
              
              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n\n');
              buffer = lines.pop() || '';
              
              lines.forEach(line => {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') {
                    updateStatus(chatStatus, "分析完成");
                    return;
                  }
                  
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.text) {
                      // 累积完整响应，但不立即显示
                      completeResponse += parsed.text;
                      // 更新状态以显示进度
                      const wordCount = completeResponse.length;
                      updateStatus(chatStatus, `AI正在分析...已收到${wordCount}个字符`, true);
                    } else if (parsed.error) {
                      updateStatus(chatStatus, `错误: ${parsed.error}`);
                      announceMessage(`处理图片时出错: ${parsed.error}`);
                    }
                  } catch (err) {
                    console.error('解析响应错误:', err);
                  }
                }
              });
              
              readStream();
            }).catch(err => {
              console.error('读取流错误:', err);
              updateStatus(chatStatus, '处理图片时出错');
              announceMessage('处理图片时出错，请重试');
              
              // 尝试显示已收到的部分响应
              if (completeResponse.trim()) {
                addMessage('AI', completeResponse);
              }
            });
          }
          
          readStream();
        })
        .catch(error => {
          console.error('分析图片错误:', error);
          updateStatus(chatStatus, '分析图片失败: ' + error.message);
          announceMessage('分析图片失败，请重试');
        });
      });

      // 截图按钮事件处理
      captureScreenshotButton.addEventListener('click', () => {
        const capturedImage = captureCurrentFrame();
        
        if (capturedImage) {
          // 保存截图并显示
          lastUploadedImage = capturedImage;
          displayImageInVideoArea(capturedImage);
          announceMessage('已截取当前画面，可以点击分析按钮进行分析');
        }
      });

      imageFileInput.addEventListener('change', () => {
        const file = imageFileInput.files[0];
        if (file) {
          announceMessage(`已选择文件: ${file.name}`);
        }
      });

      document.addEventListener('touchstart', function() {
        const synth = getSpeechSynthesis();
        if (synth && !isSpeaking) {
          const silence = new SpeechSynthesisUtterance('');
          silence.volume = 0;
          synth.speak(silence);
          synth.cancel();
        }
      }, { once: true });
    });
  </script>
</body>
</html>